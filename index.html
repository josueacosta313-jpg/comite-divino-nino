<!DOCTYPE html>
<html lang="es">
<head>
<link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso al Sistema - Comité de Fiestas</title>
    <!-- Carga de Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fondo blanco/gris claro */
        }
        /* Estilo para que el dashboard ocupe la mayor parte de la pantalla */
        #main-system {
            min-height: 90vh;
            max-width: 95vw;
            width: 100%;
            /* Centrarlo dentro del body flex */
            margin: 0 auto;
        }
        /* Estilo para los enlaces activos del menú lateral */
        .menu-link.active {
            background-color: #fcd34d; /* Dorado de Tailwind (yellow-300) */
            color: #1e3a8a; /* Azul oscuro de Tailwind (blue-900) */
            border-left: 4px solid #f59e0b; /* Dorado más fuerte */
        }
        /* Ajuste fino para inputs de la tabla y formularios */
        .table-input {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            width: 100%;
            transition: all 0.15s;
        }
        .table-input:focus {
            outline: none;
            border-color: #f59e0b; /* Dorado */
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5);
        }
        .kpi-value {
             /* Animación para el cambio de valores */
            transition: all 0.5s ease-in-out;
            will-change: transform, color;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100 p-4 sm:p-0">

    <!-- 
        =========================================================
        1. Contenedor de Inicio de Sesión (Login)
        =========================================================
    -->
    <div id="login-container" class="w-full max-w-sm p-8 space-y-6 bg-white rounded-xl shadow-2xl transition-all duration-500">
        <div class="text-center">
            <!-- LOGO EN EL LOGIN -->
            <div class="flex justify-center mb-4">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z" fill="#1e3a8a"/>
                    <path d="M12 6a6 6 0 00-6 6h2a4 4 0 014-4V6z" fill="#f59e0b"/>
                    <path d="M12 18a6 6 0 006-6h-2a4 4 0 01-4 4v2z" fill="#f59e0b"/>
                    <path d="M12 14c-1.104 0-2-.896-2-2s.896-2 2-2 2 .896 2 2-.896 2-2 2z" fill="#fff"/>
                </svg>
            </div>
            <h1 class="text-3xl font-bold text-blue-900 mb-2">Acceso al Sistema</h1>
            <!-- Mensaje con credenciales de prueba -->
            <p class="text-gray-500 text-sm mb-4">Usuarios de prueba:</p>
            <ul class="text-xs text-gray-600 space-y-1 mb-4">
                <li>Usuario: william | Contraseña: willipre (Presidente)</li>
                <li>Usuario: joselyn | Contraseña: joseteso (Tesorera)</li>
                <li>Usuario: josue | Contraseña: josusecre (Secretario)</li>
            </ul>
        </div>
        
        <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
            
            <!-- Campo Usuario -->
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                <input type="text" id="username" name="username" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150"
                       placeholder="Ingresa tu usuario">
            </div>

            <!-- Campo Contraseña -->
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                <input type="password" id="password" name="password" required
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition duration-150"
                       placeholder="Ingresa tu contraseña">
            </div>

            <!-- Mensaje de Error (Inicialmente oculto) -->
            <div id="error-message" class="text-red-600 text-sm font-medium pt-2 hidden">
                Usuario o contraseña incorrectos. Por favor, inténtalo de nuevo.
            </div>

            <!-- Botón de Inicio de Sesión (Estilo Dorado) -->
            <button type="submit"
                    class="w-full py-3 px-4 rounded-lg text-lg font-semibold text-blue-900 bg-yellow-500 hover:bg-yellow-600 focus:outline-none focus:ring-4 focus:ring-yellow-300 transition duration-300 shadow-md hover:shadow-lg">
                Iniciar sesión
            </button>
        </form>
    </div>

    <!-- 
        =========================================================
        2. Dashboard Principal (Sistema)
        =========================================================
    -->
    <div id="main-system" class="hidden bg-white rounded-xl shadow-2xl overflow-hidden transition-all duration-500 flex-col md:flex-row">

        <!-- 2.1 Menú Lateral Fijo (Sidebar) -->
        <aside id="sidebar-menu" class="w-full md:w-64 bg-blue-900 text-white flex flex-col flex-shrink-0">
            <div class="p-6 border-b border-blue-800">
                <!-- LOGO EN EL MENÚ LATERAL -->
                <div class="flex items-center mb-3">
                    <svg class="w-8 h-8 mr-3" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z" fill="#fcd34d"/>
                        <path d="M12 6a6 6 0 00-6 6h2a4 4 0 014-4V6z" fill="#1e3a8a"/>
                        <path d="M12 18a6 6 0 006-6h-2a4 4 0 01-4 4v2z" fill="#1e3a8a"/>
                        <path d="M12 14c-1.104 0-2-.896-2-2s.896-2 2-2 2 .896 2 2-.896 2-2 2z" fill="#fff"/>
                    </svg>
                    <h2 class="text-xl font-extrabold text-yellow-500 leading-tight">Comité de Fiestas</h2>
                </div>
                <p class="text-sm font-light pl-11">Divino Niño</p>
            </div>
            
            <nav class="flex-1 py-6 space-y-2">
                <!-- Opción 1: Inicio -->
                <a href="#" id="menu-inicio" onclick="showContent('inicio', this)" 
                   class="menu-link active flex items-center p-4 text-sm font-medium transition duration-150 hover:bg-yellow-500 hover:text-blue-900">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-10v10a1 1 0 001 1h3M12 4v7"></path></svg>
                    Inicio
                </a>
                <!-- Opción 2: Eventos Confirmados -->
                <a href="#" id="menu-eventos" onclick="showContent('eventos', this)" 
                   class="menu-link flex items-center p-4 text-sm font-medium transition duration-150 hover:bg-yellow-500 hover:text-blue-900">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Eventos Confirmados
                </a>
                <!-- Opción 3: Lista de Priostes y Fundadores -->
                <a href="#" id="menu-priostes" onclick="showContent('priostes', this)" 
                   class="menu-link flex items-center p-4 text-sm font-medium transition duration-150 hover:bg-yellow-500 hover:text-blue-900">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M12 10a5 5 0 110-10 5 5 0 010 10z"></path></svg>
                    Priostes y Fundadores
                </a>
                <!-- Opción 4: Abonos a Artistas y Logística -->
                <a href="#" id="menu-abonos" onclick="showContent('abonos', this)" 
                   class="menu-link flex items-center p-4 text-sm font-medium transition duration-150 hover:bg-yellow-500 hover:text-blue-900">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m0 0l-1 1m1-1l1 1m-1-1v1m-5-1h2m-2 0h-2m2 0h-2"></path></svg>
                    Abonos y Logística
                </a>
            </nav>
        </aside>

        <!-- 2.2 Contenido Principal (Content Area) -->
        <div id="main-content-area" class="flex-1 overflow-y-auto p-8 sm:p-10 bg-gray-50">
            
            <!-- Encabezado y Botón de Salida -->
            <header class="flex flex-col sm:flex-row sm:justify-between sm:items-center pb-6 mb-6 border-b border-gray-200">
                <div>
                    <div class="text-xl font-bold text-gray-700">
                        <span id="current-title">Inicio</span>
                    </div>
                    <!-- BIENVENIDA Y ROL DINÁMICO -->
                    <p id="welcome-message" class="text-sm text-blue-700 font-semibold mt-1"></p> 
                </div>
                <button onclick="handleLogout()" 
                        class="mt-4 sm:mt-0 py-2 px-4 rounded-lg font-medium text-white bg-blue-900 hover:bg-blue-800 transition duration-300 shadow-md text-sm self-end sm:self-auto">
                    Cerrar Sesión
                </button>
            </header>

            <main class="space-y-8">
                
                <!-- Contenido de INICIO (DASHBOARD DINÁMICO) -->
                <section id="content-inicio" class="content-section">
                    <h2 class="text-3xl font-extrabold text-blue-900 mb-6">Resumen Ejecutivo / KPIs</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- Tarjeta 1: RECAUDACIÓN TOTAL (Priostes) -->
                        <div class="p-6 bg-blue-50 rounded-xl shadow-lg border-t-4 border-yellow-500">
                            <p class="text-sm text-gray-500">Recaudación Total (Priostes)</p>
                            <p id="kpi-recaudacion" class="kpi-value text-4xl font-extrabold text-blue-900 mt-1">$0.00</p>
                        </div>
                        
                        <!-- Tarjeta 2: EVENTOS CONFIRMADOS -->
                        <div class="p-6 bg-blue-50 rounded-xl shadow-lg border-t-4 border-yellow-500">
                            <p class="text-sm text-gray-500">Eventos Confirmados</p>
                            <p id="kpi-eventos" class="kpi-value text-4xl font-extrabold text-blue-900 mt-1">0</p>
                        </div>
                        
                        <!-- Tarjeta 3: ARTISTAS CONTRATADOS -->
                        <div class="p-6 bg-blue-50 rounded-xl shadow-lg border-t-4 border-yellow-500">
                            <p class="text-sm text-gray-500">Artistas Contratados</p>
                            <p id="kpi-artistas" class="kpi-value text-4xl font-extrabold text-blue-900 mt-1">0</p>
                        </div>
                    </div>
                    <p class="text-gray-600 pt-8 border-t mt-8 text-sm">
                        Los indicadores clave (KPIs) se actualizan automáticamente según los registros en cada módulo.
                    </p>
                </section>

                <!-- Contenido de EVENTOS CONFIRMADOS (NUEVO CRUD) -->
                <section id="content-eventos" class="content-section hidden">
                    <h2 class="text-3xl font-extrabold text-blue-900 mb-6">Gestión de Eventos</h2>
                    
                    <!-- Formulario para agregar evento -->
                    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100 mb-8">
                        <h3 class="text-xl font-semibold text-blue-800 mb-4 border-b pb-2">Registrar Nuevo Evento</h3>
                        <form onsubmit="addEvent(event)" class="flex flex-col sm:flex-row gap-4">
                            <input type="text" id="event-name" required placeholder="Nombre del Evento (Ej: Misa de Gala)"
                                   class="table-input flex-grow">
                            <input type="date" id="event-date" required class="table-input">
                            <button type="submit"
                                    class="py-2 px-6 rounded-lg font-medium text-blue-900 bg-yellow-500 hover:bg-yellow-600 transition duration-300 shadow-md flex items-center justify-center sm:w-auto w-full">
                                Agregar Evento
                            </button>
                        </form>
                    </div>

                    <!-- Lista de Eventos -->
                    <h3 class="text-2xl font-bold text-blue-900 mb-4">Eventos Registrados (<span id="event-count">0</span>)</h3>
                    <div id="events-list-container" class="space-y-4">
                        <!-- Las tarjetas de eventos se inyectarán aquí -->
                    </div>
                </section>

                <!-- Contenido de PRIOSTES Y FUNDADORES (DINÁMICO) -->
                <section id="content-priostes" class="content-section hidden">
                    <h2 class="text-3xl font-extrabold text-blue-900 mb-6">Lista de Priostes y Fundadores</h2>
                    
                    <!-- Carpeta visible: Año 2025 -->
                    <div class="inline-flex items-center p-3 mb-6 bg-yellow-500 text-blue-900 font-semibold rounded-lg shadow-md">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>
                        Año 2025
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100 overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider w-1/3">Nombre y Apellido</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider w-1/4">Monto Abonado</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider w-auto">Observaciones</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-blue-700 uppercase tracking-wider">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="priostes-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Las filas se insertan aquí con JavaScript -->
                            </tbody>
                            <tfoot class="bg-blue-100 border-t-2 border-blue-900">
                                <tr>
                                    <!-- Celda para "TOTAL GENERAL:" -->
                                    <td colspan="2" class="px-4 py-3 text-right text-base font-semibold text-blue-900">
                                        TOTAL GENERAL:
                                    </td>
                                    <!-- Celda para el valor del total -->
                                    <td colspan="2" class="px-4 py-3 text-left text-xl font-extrabold text-green-700">
                                        <span id="total-abonos">$0.00</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button onclick="addPriosteRow()" 
                                class="py-2 px-4 rounded-lg font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-300 shadow-lg flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Agregar Registro
                        </button>
                    </div>
                </section>

                <!-- Contenido de ABONOS A ARTISTAS Y LOGÍSTICA (Formulario y Registros) -->
                <section id="content-abonos" class="content-section hidden">
                    <h2 class="text-3xl font-extrabold text-blue-900 mb-6">Gestión de Abonos y Logística</h2>
                    
                    <!-- Formulario de Registro/Edición de Abonos -->
                    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100 mb-8">
                        <h3 id="form-title" class="text-xl font-semibold text-blue-800 mb-4 border-b pb-2">Registrar Nuevo Abono</h3>
                        
                        <!-- Mensaje de Feedback (Éxito/Error) -->
                        <div id="abono-feedback" class="p-3 mb-4 rounded-lg text-sm hidden"></div>

                        <form id="abono-form" onsubmit="handleAbonoSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            
                            <!-- Campo oculto para el ID de edición -->
                            <input type="hidden" id="editing-id">

                            <div>
                                <label for="abono-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Artista o Proveedor</label>
                                <input type="text" id="abono-name" required
                                       class="table-input" placeholder="Ej: Orquesta Los Diamantes">
                            </div>

                            <div>
                                <label for="abono-concept" class="block text-sm font-medium text-gray-700 mb-1">Concepto</label>
                                <input type="text" id="abono-concept" required
                                       class="table-input" placeholder="Ej: Abono de contrato / Pago de sonido">
                            </div>

                            <div>
                                <label for="abono-amount" class="block text-sm font-medium text-gray-700 mb-1">Monto Abonado ($)</label>
                                <input type="number" id="abono-amount" step="0.01" min="0" required
                                       class="table-input text-right" placeholder="0.00">
                            </div>

                            <div>
                                <label for="abono-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha del Abono</label>
                                <input type="date" id="abono-date" required
                                       class="table-input">
                            </div>

                            <div class="md:col-span-2">
                                <label for="abono-proof" class="block text-sm font-medium text-gray-700 mb-1">Comprobante (Subir/Reemplazar imagen)</label>
                                <input type="file" id="abono-proof" accept="image/*" onchange="previewImage(event)"
                                       class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                
                                <!-- Previsualización de Imagen -->
                                <div id="image-preview-container" class="mt-3 hidden">
                                    <p class="text-xs text-gray-500 mb-1">Previsualización:</p>
                                    <img id="image-preview" src="" alt="Comprobante de Abono" class="max-h-40 w-auto rounded-lg shadow-md border border-gray-200">
                                </div>
                            </div>

                            <div class="md:col-span-2 pt-4 flex justify-end space-x-3">
                                <button type="button" id="cancel-edit-btn" onclick="cancelEdit()" 
                                        class="py-2 px-6 rounded-lg font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-300 shadow-md hidden">
                                    Cancelar Edición
                                </button>
                                <button type="submit" id="abono-submit-btn"
                                        class="py-2 px-6 rounded-lg font-medium text-blue-900 bg-yellow-500 hover:bg-yellow-600 transition duration-300 shadow-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Guardar Abono
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Contenedor de Registros de Abonos -->
                    <h3 class="text-2xl font-bold text-blue-900 mb-4">Registros de Abonos Realizados</h3>
                    <div id="abonos-records-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Tarjetas de abonos se inyectarán aquí con JavaScript -->
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- 
        =========================================================
        3. Lógica JavaScript (Estado Global y Funcionalidad Dinámica)
        =========================================================
    -->
    <script>
        // =========================================================
        // USUARIOS FIJOS Y ESTADO DE AUTENTICACIÓN
        // =========================================================
        const USERS = [
            { username: 'william', password: 'willipre', role: 'Presidente' },
            { username: 'joselyn', password: 'joseteso', role: 'Tesorera' },
            { username: 'josue', password: 'josusecre', role: 'Secretario' }
        ];

        let loggedUser = null; // Variable para almacenar el usuario logueado

        // =========================================================
        // ESTADO GLOBAL DE LA APLICACIÓN
        // =========================================================
        let priostesData = []; 
        let abonosData = [];
        let eventosData = [];

        // Elementos del DOM del Login/Sistema
        const loginContainer = document.getElementById('login-container');
        const mainSystem = document.getElementById('main-system');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const currentTitleElement = document.getElementById('current-title');
        const welcomeMessageElement = document.getElementById('welcome-message'); // Nuevo elemento
        
        // Elementos Dashboard KPI
        const kpiRecaudacion = document.getElementById('kpi-recaudacion');
        const kpiEventos = document.getElementById('kpi-eventos');
        const kpiArtistas = document.getElementById('kpi-artistas');

        // Elementos Priostes
        const tableBody = document.getElementById('priostes-table-body');
        const totalAbonosSpan = document.getElementById('total-abonos');

        // Elementos Abonos
        const abonosContainer = document.getElementById('abonos-records-container');
        const imagePreview = document.getElementById('image-preview');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const formTitle = document.getElementById('form-title');
        const abonoForm = document.getElementById('abono-form');
        const editingIdInput = document.getElementById('editing-id');
        const abonoSubmitBtn = document.getElementById('abono-submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const abonoFeedback = document.getElementById('abono-feedback');

        // Elementos Eventos
        const eventsListContainer = document.getElementById('events-list-container');
        const eventCountSpan = document.getElementById('event-count');
        const eventNameInput = document.getElementById('event-name');
        const eventDateInput = document.getElementById('event-date');

        // Estado inicial del contenido
        let currentContentId = 'inicio';
        const menuTitles = {
            'inicio': 'Inicio',
            'eventos': 'Eventos Confirmados',
            'priostes': 'Priostes y Fundadores',
            'abonos': 'Abonos y Logística'
        };

        // =========================================================
        // LÓGICA DE AUTENTICACIÓN (ACTUALIZADA)
        // =========================================================

        /**
         * Maneja el intento de inicio de sesión.
         */
        function handleLogin(event) {
            event.preventDefault(); 

            const user = usernameInput.value.trim();
            const pass = passwordInput.value.trim();

            const foundUser = USERS.find(u => u.username === user && u.password === pass);

            if (foundUser) {
                // Credenciales correctas
                loggedUser = foundUser; // Guardar usuario logueado
                errorMessage.classList.add('hidden');
                loginContainer.classList.add('hidden');
                mainSystem.classList.remove('hidden');
                
                // Actualizar el mensaje de bienvenida
                welcomeMessageElement.textContent = `Bienvenido, ${loggedUser.username.toUpperCase()} – ${loggedUser.role}`;

                // Cargar el Dashboard al inicio
                showContent('inicio', document.getElementById('menu-inicio'));
                
            } else {
                // Credenciales incorrectas
                errorMessage.classList.remove('hidden');
                passwordInput.value = ''; 
                passwordInput.focus();
            }
        }

        /**
         * Maneja el cierre de sesión.
         */
        function handleLogout() {
            loggedUser = null; // Limpiar usuario logueado
            welcomeMessageElement.textContent = ''; // Limpiar mensaje de bienvenida
            usernameInput.value = '';
            passwordInput.value = '';
            errorMessage.classList.add('hidden');
            
            mainSystem.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            usernameInput.focus();
        }

        // =========================================================
        // FUNCIONES DE DASHBOARD Y KPIs (Sin cambios funcionales)
        // =========================================================

        /** Genera un ID único simple */
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        /** Formatea un número a moneda USD. */
        function formatCurrency(amount) {
            return (amount || 0).toLocaleString('es-EC', { 
                style: 'currency', 
                currency: 'USD',
                minimumFractionDigits: 2 
            });
        }

        /**
         * Calcula todos los KPIs del Dashboard desde el estado global.
         */
        function calculateKpis() {
            // 1. RECAUDACIÓN TOTAL (Suma de montos de Priostes)
            const totalRecaudacion = priostesData.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            
            // 2. EVENTOS CONFIRMADOS
            const totalEventos = eventosData.length;

            // 3. ARTISTAS CONTRATADOS (Contar nombres únicos en Abonos)
            const contractedArtists = new Set(
                abonosData
                    .map(a => a.name.trim().toLowerCase())
                    .filter(name => name) // Asegurarse de que el nombre no esté vacío
            );
            const totalArtistas = contractedArtists.size;

            return {
                recaudacion: totalRecaudacion,
                eventos: totalEventos,
                artistas: totalArtistas
            };
        }

        /**
         * Actualiza visualmente el Dashboard.
         */
        function renderDashboard() {
            const kpis = calculateKpis();
            
            // Recaudación Total
            kpiRecaudacion.textContent = formatCurrency(kpis.recaudacion);
            
            // Eventos Confirmados
            kpiEventos.textContent = kpis.eventos;

            // Artistas Contratados
            kpiArtistas.textContent = kpis.artistas;
        }

        // =========================================================
        // LÓGICA DE PRIOSTES
        // =========================================================

        /**
         * Actualiza el campo de un prioste solo al perder el foco (onblur).
         */
        function handlePriosteInputBlur(inputElement, index, field) {
            if (index >= 0 && index < priostesData.length) {
                let value = inputElement.value.trim();
                
                if (field === 'amount') {
                    const parsedValue = parseFloat(value) || 0;
                    priostesData[index][field] = parsedValue;
                    inputElement.value = parsedValue.toFixed(2);
                } else {
                    priostesData[index][field] = value;
                }
                
                renderPriostesTable();
                showFeedback(`Campo de Prioste en el índice ${index + 1} actualizado.`, 'success');
            }
        }

        /**
         * Renderiza dinámicamente el cuerpo de la tabla de Priostes y actualiza el total.
         */
        function renderPriostesTable() {
            tableBody.innerHTML = '';
            
            if (priostesData.length === 0) {
                 tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-6 text-center text-gray-500">
                            No hay registros de Priostes y Fundadores aún. Agrega el primero.
                        </td>
                    </tr>
                `;
            }

            priostesData.forEach((p, index) => {
                const newRow = tableBody.insertRow();
                newRow.className = 'hover:bg-yellow-50/50';
                
                newRow.insertCell().innerHTML = `
                    <input type="text" class="table-input" value="${p.name}" 
                           onblur="handlePriosteInputBlur(this, ${index}, 'name')" placeholder="Nombre completo">
                `;

                newRow.insertCell().innerHTML = `
                    <input type="number" step="0.01" min="0" class="table-input monto-input text-right" 
                           value="${(p.amount || 0).toFixed(2)}" 
                           onblur="handlePriosteInputBlur(this, ${index}, 'amount')" placeholder="0.00">
                `;
                
                newRow.insertCell().innerHTML = `
                    <input type="text" class="table-input" value="${p.obs}" 
                           onblur="handlePriosteInputBlur(this, ${index}, 'obs')" placeholder="Breve nota">
                `;
                
                newRow.insertCell().innerHTML = `
                    <button onclick="deletePrioste(${index}, '${p.name}')" 
                            class="py-1 px-3 rounded-lg text-sm font-medium text-white bg-red-500 hover:bg-red-600 transition shadow-md w-full">
                        Eliminar
                    </button>
                `;
            });

            const totalRecaudacion = priostesData.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            totalAbonosSpan.textContent = formatCurrency(totalRecaudacion);
            renderDashboard();
        }

        /**
         * Agrega un nuevo registro vacío al array de Priostes.
         */
        function addPriosteRow() {
            priostesData.push({
                name: '',
                amount: 0,
                obs: '',
                id: generateUniqueId()
            });
            renderPriostesTable();
            showFeedback('Nuevo registro de Prioste agregado.', 'success');
        }

        /**
         * Elimina un registro de Prioste.
         */
        function deletePrioste(index, name) {
             if (window.confirm(`¿Estás seguro de eliminar el registro de Prioste para "${name}"? Esta acción no se puede deshacer.`)) {
                priostesData.splice(index, 1);
                renderPriostesTable();
                showFeedback('Registro de Prioste eliminado correctamente.', 'success');
            }
        }

        // =========================================================
        // LÓGICA DE EVENTOS
        // =========================================================

        /**
         * Renderiza la lista de eventos.
         */
        function renderEvents() {
            eventsListContainer.innerHTML = '';
            eventCountSpan.textContent = eventosData.length;

            if (eventosData.length === 0) {
                 eventsListContainer.innerHTML = `
                    <p class="text-gray-500 py-4 text-center border rounded-xl bg-white">
                        No hay eventos registrados. Agrega el primero.
                    </p>
                `;
            }

            eventosData.forEach(event => {
                const dateParts = event.date.split('-');
                const formattedDate = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : event.date;

                const eventCard = `
                    <div id="event-${event.id}" class="flex justify-between items-center p-4 bg-white rounded-lg shadow-md border-l-4 border-blue-600">
                        <div>
                            <p class="text-lg font-semibold text-blue-900">${event.name}</p>
                            <p class="text-sm text-gray-500">${formattedDate}</p>
                        </div>
                        <button onclick="deleteEvent('${event.id}', '${event.name}')" 
                                class="py-1 px-3 rounded-lg text-sm font-medium text-white bg-red-500 hover:bg-red-600 transition shadow-md">
                            Eliminar
                        </button>
                    </div>
                `;
                eventsListContainer.insertAdjacentHTML('beforeend', eventCard);
            });
            renderDashboard(); 
        }

        /**
         * Agrega un nuevo evento.
         */
        function addEvent(event) {
            event.preventDefault();
            const name = eventNameInput.value.trim();
            const date = eventDateInput.value;

            if (name && date) {
                eventosData.push({
                    id: generateUniqueId(),
                    name: name,
                    date: date
                });
                eventNameInput.value = '';
                eventDateInput.value = '';
                renderEvents();
                showFeedback('Evento agregado correctamente.', 'success');
            } else {
                showFeedback('Por favor, completa todos los campos del evento.', 'error');
            }
        }

        /**
         * Elimina un evento.
         */
        function deleteEvent(id, name) {
            if (window.confirm(`¿Estás seguro de eliminar el evento "${name}"? Esta acción no se puede deshacer.`)) {
                eventosData = eventosData.filter(e => e.id !== id);
                renderEvents();
                showFeedback('Evento eliminado correctamente.', 'success');
            }
        }

        // =========================================================
        // LÓGICA DE ABONOS
        // =========================================================

        /** Muestra un mensaje de feedback temporal en la UI. */
        function showFeedback(message, type = 'success') {
            const feedbackContainer = currentContentId === 'abonos' ? abonoFeedback : document.getElementById('abono-feedback-temp') || abonoFeedback;

            feedbackContainer.textContent = message;
            feedbackContainer.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            
            if (type === 'success') {
                feedbackContainer.classList.add('bg-green-100', 'text-green-700');
            } else if (type === 'error') {
                feedbackContainer.classList.add('bg-red-100', 'text-red-700');
            }

            setTimeout(() => {
                feedbackContainer.classList.add('hidden');
            }, 5000);
        }

        /**
         * Muestra una vista previa de la imagen seleccionada por el usuario.
         */
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                const editingId = editingIdInput.value;
                if (!editingId) {
                    imagePreview.src = '';
                    imagePreviewContainer.classList.add('hidden');
                }
            }
        }

        /**
         * Renderiza todas las tarjetas de abonos en el contenedor (READ).
         */
        function renderAbonos() {
            abonosContainer.innerHTML = ''; 
            
            if (abonosData.length === 0) {
                abonosContainer.innerHTML = `
                    <p class="text-gray-500 md:col-span-3 py-4 text-center border rounded-xl bg-white">
                        No hay registros de abonos aún. Utiliza el formulario superior para agregar uno.
                    </p>
                `;
            }

            abonosData.forEach(abono => {
                const amountFormatted = formatCurrency(abono.amount);
                const dateParts = abono.date.split('-');
                const formattedDate = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : abono.date;

                const cardHtml = `
                    <div id="abono-${abono.id}" class="bg-blue-50 p-5 rounded-xl shadow-lg border-t-4 border-yellow-600 hover:shadow-xl transition duration-200 space-y-3 flex flex-col">
                        <p class="text-xs font-medium text-gray-500">${formattedDate}</p>
                        <h4 class="text-lg font-extrabold text-blue-900">${abono.name}</h4>
                        <p class="text-sm text-gray-700 flex-grow">${abono.concept}</p>
                        
                        <div class="py-2 border-t border-b border-yellow-200 flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-600">Monto:</span>
                            <span class="text-2xl font-bold text-green-700">${amountFormatted}</span>
                        </div>
                        
                        ${abono.imagePreview ? `
                            <div class="pt-2">
                                <p class="text-xs font-medium text-gray-500 mb-1">Comprobante Adjunto:</p>
                                <img src="${abono.imagePreview}" alt="Comprobante de ${abono.name}" class="w-full h-24 object-cover rounded-lg shadow-md cursor-pointer hover:opacity-90 transition"
                                     onclick="window.open('${abono.imagePreview}', '_blank')">
                            </div>
                        ` : '<p class="text-xs text-red-500 pt-2">Sin comprobante adjunto.</p>'}

                        <!-- Botones de Acción -->
                        <div class="flex justify-end space-x-2 pt-3">
                            <button onclick="editAbono('${abono.id}')"
                                class="py-1 px-3 rounded-lg text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 transition shadow-md">
                                Editar
                            </button>
                            <button onclick="deleteAbono('${abono.id}', '${abono.name}')"
                                class="py-1 px-3 rounded-lg text-sm font-medium text-white bg-red-500 hover:bg-red-600 transition shadow-md">
                                Eliminar
                            </button>
                        </div>
                    </div>
                `;
                abonosContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
            renderDashboard(); 
        }


        /**
         * Maneja el envío del formulario: Creación o Actualización (CREATE/UPDATE).
         */
        function handleAbonoSubmit(event) {
            event.preventDefault();

            const id = editingIdInput.value;
            const name = document.getElementById('abono-name').value.trim();
            const concept = document.getElementById('abono-concept').value.trim();
            const amount = parseFloat(document.getElementById('abono-amount').value) || 0;
            const date = document.getElementById('abono-date').value;
            const proofFile = document.getElementById('abono-proof').files[0];

            // Función para guardar/actualizar el registro
            const saveRecord = (imageBase64) => {
                const newRecord = {
                    name,
                    concept,
                    amount,
                    date,
                    imagePreview: imageBase64,
                };

                if (id) {
                    // MODO EDICIÓN
                    const index = abonosData.findIndex(a => a.id === id);
                    if (index !== -1) {
                        newRecord.imagePreview = imageBase64 || abonosData[index].imagePreview;
                        abonosData[index] = { id, ...newRecord };
                        showFeedback('Registro actualizado exitosamente.', 'success');
                    }
                } else {
                    // MODO CREACIÓN
                    abonosData.unshift({ id: generateUniqueId(), ...newRecord });
                    showFeedback('Nuevo abono registrado exitosamente.', 'success');
                }

                cancelEdit(); 
                renderAbonos();
            };

            // Lógica para manejar la subida de imagen (Base64)
            if (proofFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    saveRecord(e.target.result);
                };
                reader.readAsDataURL(proofFile);
            } else {
                saveRecord(null);
            }
        }

        /**
         * Carga los datos de un registro en el formulario para editar (UPDATE - load).
         */
        function editAbono(id) {
            const abono = abonosData.find(a => a.id === id);
            if (!abono) return showFeedback('Registro no encontrado para edición.', 'error');

            editingIdInput.value = abono.id;
            document.getElementById('abono-name').value = abono.name;
            document.getElementById('abono-concept').value = abono.concept;
            document.getElementById('abono-amount').value = abono.amount;
            document.getElementById('abono-date').value = abono.date;

            if (abono.imagePreview) {
                imagePreview.src = abono.imagePreview;
                imagePreviewContainer.classList.remove('hidden');
            } else {
                imagePreview.src = '';
                imagePreviewContainer.classList.add('hidden');
            }
            document.getElementById('abono-proof').value = ''; 

            formTitle.textContent = 'Editar Abono Existente';
            abonoSubmitBtn.textContent = 'Actualizar Abono';
            cancelEditBtn.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        }

        /**
         * Sale del modo edición y limpia el formulario.
         */
        function cancelEdit() {
            abonoForm.reset();
            editingIdInput.value = '';
            
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');

            formTitle.textContent = 'Registrar Nuevo Abono';
            abonoSubmitBtn.textContent = 'Guardar Abono';
            cancelEditBtn.classList.add('hidden');
            abonoFeedback.classList.add('hidden');
        }

        /**
         * Elimina un registro de abono con confirmación (DELETE).
         */
        function deleteAbono(id, name) {
            if (window.confirm(`¿Estás seguro de eliminar el registro de abono de "${name}"? Esta acción no se puede deshacer.`)) {
                abonosData = abonosData.filter(a => a.id !== id);
                renderAbonos();
                showFeedback('Registro eliminado correctamente.', 'success');
            }
        }


        // =========================================================
        // Lógica de Navegación
        // =========================================================

        /**
         * Muestra la sección de contenido solicitada y actualiza el estado activo del menú.
         */
        function showContent(contentId, clickedElement) {
            event.preventDefault(); 
            
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            document.querySelectorAll('.menu-link').forEach(link => {
                link.classList.remove('active');
            });

            const targetContent = document.getElementById(`content-${contentId}`);
            if (targetContent) {
                targetContent.classList.remove('hidden');
            }

            if (clickedElement) {
                clickedElement.classList.add('active');
            }

            currentTitleElement.textContent = menuTitles[contentId] || 'Dashboard';
            currentContentId = contentId;

            if (contentId === 'abonos') {
                renderAbonos(); 
                cancelEdit(); 
            } else if (contentId === 'priostes') {
                renderPriostesTable(); 
            } else if (contentId === 'eventos') {
                renderEvents(); 
            } else if (contentId === 'inicio') {
                renderDashboard();
            }
        }

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            renderDashboard();
            renderPriostesTable();
            renderEvents(); 
            loginContainer.classList.remove('hidden'); 
        });

    </script>
</body>
</html>